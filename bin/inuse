#!/bin/sh
#
# inuse - z/OS Dataset Usage Checker
# Shows which jobs/systems are using a specified dataset
#

# Get script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

. "$LIB_DIR/common.sh"
. "$LIB_DIR/output_formatter.sh"
. "$LIB_DIR/zoau_utils.sh"

usage() {
    cat << 'EOF'
Usage: inuse [OPTIONS] <dataset>

Check which jobs/systems are using a z/OS dataset.

Arguments:
  dataset              Dataset name to check (e.g., SOME.LOAD.LIB)

Options:
  -j, --json          Output in JSON format
  -h, --help          Display this help message

Examples:
  inuse SOME.LOAD.LIB
  inuse --json MY.DATASET.NAME
  inuse -j USER.PROD.LOADLIB

Output:
  Shows LPAR, job name, ASID, TCB address, and lock status (SHARE/EXCLUSIVE)
  for each system/job using the dataset.

EOF
    exit 1
}

# Parse GRS output into pipe-delimited format: LPAR|JOBNAME|ASID|TCBADDR|LOCK|STATUS
parse_grs_data() {
    _output="$1"
    _dataset="$2"

    # Check if dataset is in use
    if ! echo "$_output" | grep -q "SYSDSN.*$_dataset"; then
        return 1
    fi

    # Parse using AWK for better performance
    echo "$_output" | awk -v dataset="$_dataset" '
        # Found the header line - start processing data
        /SYSNAME.*JOBNAME.*ASID.*TCBADDR.*EXC\/SHR.*STATUS/ {
            in_data = 1
            next
        }

        # Process data lines
        in_data && NF >= 6 {
            # Extract fields and output in pipe-delimited format
            printf "%s|%s|%s|%s|%s|%s\n", $1, $2, $3, $4, $5, $6
        }
    '

    return 0
}

format_output_human() {
    _dataset="$1"
    _data="$2"

    echo "Dataset: $_dataset"

    if [ -z "$_data" ]; then
        echo "Status: Not currently in use"
        return 0
    fi

    echo "Status: In use"
    echo ""
    printf "%-10s %-16s %-8s %-12s %-10s %-10s\n" \
        "LPAR" "JOBNAME" "ASID" "TCBADDR" "LOCK" "STATUS"
    echo "--------------------------------------------------------------------------------"

    # Process each line of data
    echo "$_data" | while IFS='|' read -r lpar jobname asid tcbaddr lock status; do
        printf "%-10s %-16s %-8s %-12s %-10s %-10s\n" \
            "$lpar" "$jobname" "$asid" "$tcbaddr" "$lock" "$status"
    done
}

format_output_json() {
    _dataset="$1"
    _data="$2"

    echo "{"
    echo "  \"dataset\": \"$_dataset\","

    if [ -z "$_data" ]; then
        echo "  \"in_use\": false,"
        echo "  \"users\": []"
        echo "}"
        return 0
    fi

    echo "  \"in_use\": true,"
    echo "  \"users\": ["

    # Process each line and format as JSON
    _first=1
    echo "$_data" | while IFS='|' read -r lpar jobname asid tcbaddr lock status; do
        if [ $_first -eq 0 ]; then
            echo ","
        fi
        cat << EOF
    {
      "lpar": "$lpar",
      "jobname": "$jobname",
      "asid": "$asid",
      "tcbaddr": "$tcbaddr",
      "lock_type": "$lock",
      "status": "$status"
    }
EOF
        _first=0
    done

    echo "  ]"
    echo "}"
}

parse_arguments() {
    JSON_OUTPUT=0
    DATASET=""

    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)
                usage
                ;;
            -j|--json)
                JSON_OUTPUT=1
                shift
                ;;
            -*)
                error_exit "Unknown option: $1"
                ;;
            *)
                if [ -z "$DATASET" ]; then
                    # Convert dataset name to uppercase for z/OS compatibility
                    DATASET=$(to_uppercase "$1")
                else
                    error_exit "Multiple datasets specified"
                fi
                shift
                ;;
        esac
    done

    # Validate dataset was provided
    validate_required "$DATASET" "Dataset name"
}

query_dataset_usage() {
    _dataset="$1"

    _output=$(opercmd -v -w "d grs,res=(*,'$_dataset') scope=*" 2>&1)
    _rc=$?

    if [ $_rc -ne 0 ]; then
        echo "Error: Failed to execute opercmd (RC=$_rc)" >&2
        echo "$_output" >&2
        exit 1
    fi

    echo "$_output"
}

main() {
    # Parse command line arguments
    parse_arguments "$@"

    # Validate ZOAU is available
    check_zoau

    # Query GRS for dataset usage
    grs_output=$(query_dataset_usage "$DATASET")

    # Parse the GRS output
    parsed_data=$(parse_grs_data "$grs_output" "$DATASET")

    # Format and display output
    if [ $JSON_OUTPUT -eq 1 ]; then
        format_output_json "$DATASET" "$parsed_data"
    else
        format_output_human "$DATASET" "$parsed_data"
    fi
}

# Run main function
main "$@"
