#!/bin/sh
#
# LOGR Structure Manager for z/OS
# Manages LOGR structures and log streams using IXCMIAPU
#

# Get script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

. "$LIB_DIR/common.sh"
. "$LIB_DIR/zoau_utils.sh"

# Set temporary directory
TMPDIR="${TMPDIR:-/tmp}"

# Function to display usage
usage() {
    cat << 'EOF'
Usage: logr_manager <command> [options]

Commands:
  list [pattern]           - List LOGR structures (default: LOG_*)
  delete <logstream>       - Delete log stream(s) by name or pattern

Examples:
  logr_manager list
  logr_manager list 'LOG_PROD_*'
  logr_manager delete MYCICS.DFHLOG
  logr_manager delete 'MYCICS.*'
  logr_manager delete 'MY*'
EOF
    exit 1
}

# Function to execute IXCMIAPU command with spinner
execute_ixcmiapu() {
    SYSIN_FILE="$1"
    OUTPUT_FILE="$2"
    MESSAGE="$3"

    if [ -n "$MESSAGE" ]; then
        printf "$MESSAGE"
    fi

    mvscmdauth --pgm=IXCMIAPU --sysin="$SYSIN_FILE" --sysprint="$OUTPUT_FILE" > /dev/null 2>&1 &
    CMDPID=$!
    show_spinner $CMDPID
    wait $CMDPID

    if [ -n "$MESSAGE" ]; then
        printf "\r                                    \r"
    fi

    return $?
}

# Function to check if line should be filtered
is_filtered_line() {
    LINE="$1"
    case "$LINE" in
        ""|"-"*|"+"*|"LOGSTREAM"|"CONNECTION") return 0 ;;
        *"ADMINISTRATIVE"*) return 0 ;;
        LOG_*_[0-9]*) return 0 ;;
        *) return 1 ;;
    esac
}

# Function to parse log streams from IXCMIAPU output
parse_logstreams() {
    OUTFILE="$1"
    PATTERN="$2"
    IN_LOGSTREAM_LIST=0
    RESULT=""

    while IFS= read -r line; do
        # Check for section markers
        echo "$line" | grep "LOGSTREAM NAME.*CONNECTION" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            IN_LOGSTREAM_LIST=1
            continue
        fi

        echo "$line" | grep "LOGSTREAMS CURRENTLY DEFINED" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            IN_LOGSTREAM_LIST=0
            continue
        fi

        # Parse log stream names
        if [ $IN_LOGSTREAM_LIST -eq 1 ]; then
            STREAM=$(echo "$line" | awk '{print $1}')

            if is_filtered_line "$STREAM"; then
                continue
            fi

            if [ -n "$STREAM" ]; then
                if [ -n "$PATTERN" ]; then
                    echo "$STREAM" | grep -E "$PATTERN" > /dev/null 2>&1
                    if [ $? -eq 0 ]; then
                        RESULT="$RESULT$STREAM
"
                    fi
                else
                    RESULT="$RESULT$STREAM
"
                fi
            fi
        fi
    done < "$OUTFILE"

    echo "$RESULT"
}

# Function to get list of log streams matching pattern
get_matching_logstreams() {
    PATTERN="$1"

    TEMPIN="$TMPDIR/logr_sysin_$$.txt"
    TEMPOUT="$TMPDIR/logr_output_$$.txt"

    cat > "$TEMPIN" << EOF
  DATA TYPE(LOGR) REPORT(NO)
  LIST STRUCTURE NAME(LOG_*) DETAIL(YES)
EOF

    execute_ixcmiapu "$TEMPIN" "$TEMPOUT" "Searching for matching log streams..."

    GREP_PATTERN=$(echo "$PATTERN" | sed 's/\*/\.\*/g')
    LOGSTREAMS=$(parse_logstreams "$TEMPOUT" "$GREP_PATTERN")

    rm -f "$TEMPIN" "$TEMPOUT"
    echo "$LOGSTREAMS"
}

# Function to list LOGR structures
list_structures() {
    # Check if multiple arguments were passed (shell expanded wildcard)
    if [ $# -gt 1 ]; then
        echo "Warning: Multiple arguments detected. Shell may have expanded wildcards."
        echo "Falling back to default pattern: LOG_*"
        echo "Tip: Use quotes to prevent shell expansion: logr_manager list '*'"
        echo ""
        PATTERN="LOG_*"
    else
        PATTERN="${1:-LOG_*}"
    fi

    echo "Listing LOGR structures matching: $PATTERN"
    echo ""

    TEMPIN="$TMPDIR/logr_sysin_$$.txt"
    TEMPOUT="$TMPDIR/logr_output_$$.txt"

    cat > "$TEMPIN" << EOF
  DATA TYPE(LOGR) REPORT(NO)
  LIST STRUCTURE NAME($PATTERN) DETAIL(YES)
EOF

    execute_ixcmiapu "$TEMPIN" "$TEMPOUT"

    # Format output header
    echo ""
    echo "=========================================="
    echo "LOGR STRUCTURES AND LOG STREAMS"
    echo "=========================================="
    printf "%-30s %-40s\n" "STRUCTURE NAME" "LOG STREAM NAME"
    echo "------------------------------------------"

    CURRENT_STRUCT=""
    IN_LOGSTREAM_LIST=0

    while IFS= read -r line; do
        # Check for structure name
        echo "$line" | grep "STRUCTURE NAME(" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            CURRENT_STRUCT=$(echo "$line" | sed 's/.*STRUCTURE NAME(\([^)]*\)).*/\1/')
            IN_LOGSTREAM_LIST=0
            continue
        fi

        # Check for log stream section start
        echo "$line" | grep "LOGSTREAM NAME.*CONNECTION" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            IN_LOGSTREAM_LIST=1
            continue
        fi

        # Check for log stream section end
        echo "$line" | grep "LOGSTREAMS CURRENTLY DEFINED" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            IN_LOGSTREAM_LIST=0
            continue
        fi

        # Parse and display log streams
        if [ $IN_LOGSTREAM_LIST -eq 1 ] && [ -n "$CURRENT_STRUCT" ]; then
            LOGSTREAM=$(echo "$line" | awk '{print $1}')

            if is_filtered_line "$LOGSTREAM"; then
                continue
            fi

            if [ -n "$LOGSTREAM" ]; then
                printf "%-30s %-40s\n" "$CURRENT_STRUCT" "$LOGSTREAM"
            fi
        fi
    done < "$TEMPOUT"

    echo "=========================================="

    rm -f "$TEMPIN" "$TEMPOUT"
}

# Function to delete log streams
delete_logstream() {
    LOGSTREAM="$1"

    if [ -z "$LOGSTREAM" ]; then
        echo "Error: Log stream name required"
        usage
    fi

    # Check if wildcard is used
    echo "$LOGSTREAM" | grep '\*' > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        # Wildcard pattern - expand to explicit names
        echo "Wildcard detected in pattern: $LOGSTREAM"
        echo "Expanding to explicit log stream names..."
        echo ""

        LOGSTREAMS=$(get_matching_logstreams "$LOGSTREAM")

        if [ -z "$LOGSTREAMS" ]; then
            echo "No log streams found matching pattern: $LOGSTREAM"
            return 1
        fi

        STREAM_COUNT=$(echo "$LOGSTREAMS" | grep -c "^")
        echo "Found $STREAM_COUNT log stream(s) matching pattern:"
        echo "$LOGSTREAMS"
        echo ""

        # Confirm deletion
        echo "WARNING: This will delete $STREAM_COUNT log stream(s)!"
        printf "Continue? (yes/no): "
        read CONFIRM

        if [ "$CONFIRM" != "yes" ]; then
            echo "Deletion cancelled"
            return 0
        fi
    else
        # Single explicit log stream
        LOGSTREAMS="$LOGSTREAM"
        STREAM_COUNT=1
    fi

    # Build delete command
    TEMPIN="$TMPDIR/logr_sysin_$$.txt"
    TEMPOUT="$TMPDIR/logr_delout_$$.txt"

    echo "  DATA TYPE(LOGR) REPORT(NO)" > "$TEMPIN"
    echo "$LOGSTREAMS" | while IFS= read -r stream; do
        if [ -n "$stream" ]; then
            echo "  DELETE LOGSTREAM NAME($stream)" >> "$TEMPIN"
        fi
    done

    # Execute delete
    if [ $STREAM_COUNT -eq 1 ]; then
        printf "Deleting log stream: $LOGSTREAM..."
    else
        printf "Deleting $STREAM_COUNT log stream(s)..."
    fi
    echo ""

    execute_ixcmiapu "$TEMPIN" "$TEMPOUT"
    RC=$?

    echo ""
    if [ $RC -eq 0 ]; then
        if [ $STREAM_COUNT -eq 1 ]; then
            echo "Successfully deleted log stream: $LOGSTREAM"
        else
            echo "Successfully deleted $STREAM_COUNT log stream(s)"
        fi
    else
        if [ $STREAM_COUNT -eq 1 ]; then
            echo "Error deleting log stream: $LOGSTREAM (RC=$RC)"
        else
            echo "Error during deletion (RC=$RC)"
        fi
        echo ""
        echo "Error details:"
        grep "IXG.*E" "$TEMPOUT" 2>/dev/null
    fi

    rm -f "$TEMPIN" "$TEMPOUT"
    return $RC
}

# Main script logic
if [ $# -lt 1 ]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    list)
        # Pass all arguments to handle multiple args detection
        list_structures "$@"
        ;;
    delete)
        if [ $# -lt 1 ]; then
            echo "Error: Log stream name or pattern required"
            usage
        fi
        delete_logstream "$1"
        ;;
    *)
        echo "Error: Unknown command: $COMMAND"
        usage
        ;;
esac

exit $?
